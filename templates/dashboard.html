{% extends "base.html" %}

{% block title %}Dashboard | ANIDS{% endblock %}

{% block head %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/dashboard.css') }}">
{% endblock %}

{% block content %}
<div class="dashboard-page">
  <div class="dashboard-container">

    <h1 class="dashboard-title">üõ°Ô∏è Network Intrusion Detection Dashboard</h1>

    <!-- === Summary Stats === -->
    <div class="stats">
      <div class="stat-box">
        <div class="stat-number">{{ total_predictions }}</div>
        <div class="stat-label">Total Records</div>
      </div>

      <div class="stat-box">
        <div class="stat-number">{{ attack_count }}</div>
        <div class="stat-label">Attacks Detected</div>
      </div>

      <div class="stat-box">
        <div class="stat-number">{{ normal_count }}</div>
        <div class="stat-label">Normal Traffic</div>
      </div>

      <div class="stat-box">
        <div class="stat-number">
          {% if accuracy is not none %}
            {{ accuracy }}%
          {% else %}
            N/A
          {% endif %}
        </div>
        <div class="stat-label">Model Accuracy</div>
      </div>
    </div>

    <!-- === Charts Section === -->
    {% if attack_counts %}
    <div class="charts">

      <!-- Chart 1 -->
      <div class="chart-card">
        <h2>Attack Type Distribution</h2>
        <div style="height:260px;">
          <canvas id="attackChart"></canvas>
        </div>
      </div>

      <!-- Chart 2 -->
      <div class="chart-card">
        <h2>Normal vs Attack Summary</h2>
        <div style="height:260px;">
          <canvas id="summaryChart"></canvas>
        </div>
      </div>

      <!-- Chart 3 (centered by CSS nth-child rule) -->
      <div class="chart-card">
        <h2>All Traffic Categories</h2>
        <div style="height:260px;">
          <canvas id="categoryChart"></canvas>
        </div>
      </div>

    </div>
    {% endif %}

    <!-- === Buttons === -->
    <div class="actions">
      <button class="button" onclick="window.location.href='/upload';">üì§ Upload New Data</button>
      <button class="button" onclick="window.location.href='/download_report';">üìä Download Report</button>
    </div>

  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

{% if attack_counts %}
<script>
  const attackLabels = {{ attack_counts.keys()|list|safe }};
  const attackData   = {{ attack_counts.values()|list|safe }};
  const normalCount  = {{ normal_count }};
  const attackCount  = {{ attack_count }};

  // Global animation defaults
  Chart.defaults.animation.duration = 1400;
  Chart.defaults.animation.easing = 'easeInOutQuart';

  // Colors for bar + doughnut (repeats if labels > colors length)
  const bgColors = [
    '#22d3ee', '#60a5fa', '#a78bfa', '#f87171',
    '#facc15', '#4ade80', '#fb7185', '#94a3b8',
    '#fb923c', '#34d399', '#818cf8', '#f472b6'
  ];

  const borderColors = [
    '#0891b2', '#2563eb', '#7c3aed', '#dc2626',
    '#ca8a04', '#16a34a', '#e11d48', '#475569',
    '#ea580c', '#059669', '#4f46e5', '#db2777'
  ];

  const barBackground = attackLabels.map((_, i) => bgColors[i % bgColors.length]);
  const barBorder     = attackLabels.map((_, i) => borderColors[i % borderColors.length]);

  // ----- Chart 1: Attack distribution (multi-color bars) -----
  new Chart(document.getElementById('attackChart'), {
    type: 'bar',
    data: {
      labels: attackLabels,
      datasets: [{
        label: 'Attack Count',
        data: attackData,
        backgroundColor: barBackground,
        borderColor: barBorder,
        borderWidth: 2,
        borderRadius: 8,
        borderSkipped: false
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(15,23,42,0.95)',
          titleColor: '#e5e7eb',
          bodyColor: '#cbd5e1',
          borderColor: 'rgba(148,163,184,0.25)',
          borderWidth: 1
        }
      },
      scales: {
        x: {
          ticks: {
            color: '#cbd5e1',
            maxRotation: 45,
            minRotation: 0,
            font: { size: 11 }
          },
          grid: { color: 'rgba(148,163,184,0.10)' }
        },
        y: {
          beginAtZero: true,
          ticks: { color: '#cbd5e1', font: { size: 11 } },
          grid: { color: 'rgba(148,163,184,0.10)' }
        }
      }
    }
  });

  // ----- Chart 2: Normal vs Attack (2 colors) -----
  new Chart(document.getElementById('summaryChart'), {
    type: 'bar',
    data: {
      labels: ['Normal', 'Attack'],
      datasets: [{
        label: 'Count',
        data: [normalCount, attackCount],
        backgroundColor: ['#22c55e', '#ef4444'],
        borderColor: ['#16a34a', '#dc2626'],
        borderWidth: 2,
        borderRadius: 8,
        borderSkipped: false
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(15,23,42,0.95)',
          titleColor: '#e5e7eb',
          bodyColor: '#cbd5e1',
          borderColor: 'rgba(148,163,184,0.25)',
          borderWidth: 1
        }
      },
      scales: {
        x: {
          ticks: { color: '#cbd5e1', font: { size: 12, weight: 'bold' } },
          grid: { color: 'rgba(148,163,184,0.10)' }
        },
        y: {
          beginAtZero: true,
          ticks: { color: '#cbd5e1', font: { size: 11 } },
          grid: { color: 'rgba(148,163,184,0.10)' }
        }
      }
    }
  });

  // ----- Chart 3: Doughnut (same colors as bars) -----
  new Chart(document.getElementById('categoryChart'), {
    type: 'doughnut',
    data: {
      labels: attackLabels,
      datasets: [{
        label: 'Traffic',
        data: attackData,
        backgroundColor: barBackground,
        borderColor: 'rgba(15,23,42,1)',
        borderWidth: 2,
        hoverOffset: 10
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '62%',
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            color: '#e5e7eb',
            padding: 12,
            font: { size: 11 },
            usePointStyle: true,
            pointStyle: 'circle'
          }
        },
        tooltip: {
          backgroundColor: 'rgba(15,23,42,0.95)',
          titleColor: '#e5e7eb',
          bodyColor: '#cbd5e1',
          borderColor: 'rgba(148,163,184,0.25)',
          borderWidth: 1
        }
      }
    }
  });
</script>
{% endif %}
{% endblock scripts %}

-